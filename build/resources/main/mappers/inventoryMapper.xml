<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="InventoryMapper">
    <resultMap id="inventoryResultMap" type="com.squer.promobee.service.repository.domain.Inventory">
        <id property="id" column="id_inv"/>
        <result property="packSize" column="pack_size_inv"/>
        <result property="poNo" column="po_no_inv"/>
        <result property="limid" column="limid_inv" />
        <result property="postingDate" column="posting_date_inv" />
        <result property="expiryDate" column="expiry_date_inv" />
        <result property="medicalCode" column="medical_code_inv" />
        <result property="ratePerUnit" column="rate_per_unit_inv" />
        <result property="qtyReceived" column="qty_received_inv" />
        <result property="qtyAllocated" column="qty_allocated_inv" />
        <result property="qtyDispatched" column="qty_allocated_inv" />
        <result property="numBoxes" column="num_boxes_inv" />
        <result property="isUnitAllocation" column="is_unit_allocation_inv" />
        <result property="batchNo" column="batch_no_inv" />
        <result property="isBlockItem" column="is_block_item_inv" />
        <result property="comment" column="comment_inv" />
        <result property="hsnCode" column="hsn_code_inv" />
        <result property="rate" column="rate_per_inv" />
        <result property="units" column="units_inv" />
        <result property="createdAt" column="created_on_inv"/>
        <result property="createdBy" column="created_by_inv"/>
        <result property="updatedAt" column="updated_on_inv"/>
        <result property="updatedBy" column="updated_by_inv"/>
        <association property="ccmID" javaType="com.squer.promobee.security.domain.NamedSquerEntity">
            <id property="id" column="id_ccm_inv"/>
            <result property="name" column="name_ccm"/>
        </association>
        <association property="categoryId" javaType="com.squer.promobee.security.domain.NamedSquerEntity">
            <id property="id" column="id_itc_inv"/>
            <result property="name" column="name_itc"/>
        </association>
        <association property="grn" column="id_grn_inv" select="getGRN" javaType="com.squer.promobee.security.domain.SquerEntity">
            <id property="id" column="id_grn"/>
        </association>
        <association property="vendorId" javaType="com.squer.promobee.security.domain.NamedSquerEntity">
            <id property="id" column="id_vnd_inv"/>
            <result property="name" column="name_vnd"/>
        </association>
        <association property="item" javaType="com.squer.promobee.security.domain.NamedSquerEntity">
            <id property="id" column="id_itm_inv"/>
            <result property="name" column="name_itm"/>
        </association>
    </resultMap>

    <select id="getGRN" parameterType="map" resultType="com.squer.promobee.service.repository.domain.GRNAcknowledgement" >
        select id_grn as id from GRN_ACKNOWLEDGEMENT_GRN where id_grn=#{id_grn_inv}
    </select>

    <select id="getAllocationInventoryWithCostcenter" parameterType="map" resultType="com.squer.promobee.controller.dto.AllocationInventoryDetailsWithCostCenterDTO" >
        SELECT INV.ID_INV, 1 AS 'isItem',CCM.ID_CCM AS 'costCenterID',CCM.NAME_CCM AS 'costCenterName',ITM.ID_ITM AS 'itemID',ITM.NAME_ITM AS 'itemName',
        INV.QTY_RECEIVED_INV AS qtyReceived, INV.QTY_ALLOCATED_INV AS qtyAllocated, INV.QTY_DISPATCHED_INV AS qtyDispatched,
        isnull((INV.QTY_RECEIVED_INV - INV.QTY_ALLOCATED_INV - INV.QTY_DISPATCHED_INV),0) AS 'stock',INV.EXPIRY_DATE_INV AS 'expiryDate',
        INV.PO_NO_INV AS 'poNo',INV.PACK_SIZE_INV AS 'packSize',
        SUM_DID.QUANTITY_DISPATCH_DID AS 'quantityAllocated',
        INV.ID_INV AS 'inventoryId', #{planId} as 'planId',
        INV.IS_BLOCK_ITEM_INV as 'isBlockItem'
        FROM INVENTORY_INV INV JOIN COST_CENTER_MASTER_CCM CCM ON INV.ID_CCM_INV = CCM.ID_CCM
        JOIN COSTCENTER_BRAND_CBR CBR ON CCM.ID_CCM = CBR.ID_CCM_CBR
        JOIN ITEM_MASTER_ITM ITM ON INV.ID_ITM_INV = ITM.ID_ITM
        JOIN ITEM_CATEGORY_MASTER_ITC ITC ON INV.ID_ITC_INV = ITC.ID_ITC
        JOIN BRANDMANAGER_BRAND_BBR BBR ON CBR.ID_BRD_CBR = BBR.ID_BRD_BBR
        LEFT JOIN (SELECT DID.ID_INV_DID ID_INV_DID, SUM(QUANTITY_DISPATCH_DID) QUANTITY_DISPATCH_DID  from DISPATCH_DETAIL_DID DID where  DID.ID_DIP_DID = #{planId}
        group by DID.ID_INV_DID) as SUM_DID on SUM_DID.ID_INV_DID = INV.ID_INV
        WHERE BBR.ID_USR_BBR = #{userId} AND DATEADD(DAY,ITC.CUTOFF_BEFORE_DAYS_ITC,CONVERT(date, GETDATE())) &lt; INV.EXPIRY_DATE_INV AND ITM.IS_ACTIVE_ITM != 0 and INV.IS_BLOCK_ITEM_INV=0
        UNION
        SELECT INV1.ID_INV, 0 AS 'isItem',BRD1.ID_BRD AS 'costCenterID', BRD1.NAME_BRD AS 'costCenterName',SMP.ID_SMP AS 'itemID',SMP.NAME_SMP AS 'itemName',
                INV1.QTY_RECEIVED_INV AS qtyReceived, INV1.QTY_ALLOCATED_INV AS qtyAllocated, INV1.QTY_DISPATCHED_INV AS qtyDispatched,
        isnull((INV1.QTY_RECEIVED_INV - INV1.QTY_ALLOCATED_INV - INV1.QTY_DISPATCHED_INV),0) AS 'stock',INV1.EXPIRY_DATE_INV AS 'expiryDate',
        INV1.PO_NO_INV AS 'poNo',INV1.PACK_SIZE_INV AS 'packSize',
        SUM_DID.QUANTITY_DISPATCH_DID AS 'quantityAllocated',
        INV1.ID_INV AS 'inventoryId', #{planId} as 'planId',
        INV1.IS_BLOCK_ITEM_INV  as 'isBlockItem'
        FROM SAMPLE_MASTER_SMP SMP
        JOIN INVENTORY_INV INV1 ON SMP.LMID_SMP = INV1.LMID_INV
        JOIN ITEM_CATEGORY_MASTER_ITC ITC1 ON INV1.ID_ITC_INV = ITC1.ID_ITC
        JOIN BRANDMANAGER_BRAND_BBR BBR1 ON SMP.ID_BRD_SMP = BBR1.ID_BRD_BBR
        JOIN BRAND_MASTER_BRD BRD1 ON BBR1.ID_BRD_BBR = BRD1.ID_BRD
        LEFT JOIN (SELECT DID.ID_INV_DID ID_INV_DID, SUM(QUANTITY_DISPATCH_DID) QUANTITY_DISPATCH_DID  from DISPATCH_DETAIL_DID DID where  DID.ID_DIP_DID = #{planId}  group by DID.ID_INV_DID) as SUM_DID on SUM_DID.ID_INV_DID = INV1.ID_INV
        WHERE BBR1.ID_USR_BBR = #{userId} AND DATEADD(DAY,ITC1.CUTOFF_BEFORE_DAYS_ITC,CONVERT(date, GETDATE())) &lt; INV1.EXPIRY_DATE_INV
        AND SMP.IS_ACTIVE_SMP != 0 and INV1.IS_BLOCK_ITEM_INV=0
        ORDER BY CCM.NAME_CCM,ITM.NAME_ITM
    </select>

    <select id="planDistributionForItemSelect" resultType="Map">
        SELECT ID_TEM_RCT, sum(QUANTITY_DISPATCH_DID) QUANTITY, ID_ITM_INV
        from DISPATCH_DETAIL_DID
        inner join RECIPIENT_MASTER_RCT on ID_RCT = ID_RCT_DID
        inner join INVENTORY_INV on ID_INV = ID_INV_DID
        where ID_DIP_DID = #{planId}
        group by ID_TEM_RCT, ID_ITM_INV
    </select>

    <insert id="insertInventory">
        insert into INVENTORY_INV (ID_INV, ID_ITM_INV, ID_GRN_INV, PACK_SIZE_INV, PO_NO_INV, ID_CCM_INV, LMID_INV, POSTING_DATE_INV, EXPIRY_DATE_INV, ID_ITC_INV, MEDICAL_CODE_INV, ID_VND_INV, RATE_PER_UNIT_INV, QTY_RECEIVED_INV, QTY_ALLOCATED_INV, QTY_DISPATCHED_INV, NUM_BOXES_INV,
         IS_UNIT_ALLOCATION_INV, BATCH_NO_INV, CREATED_ON_INV, CREATED_BY_INV, UPDATED_ON_INV, UPDATED_BY_INV, HSN_CODE_INV, RATE_PER_INV, UNITS_INV) values(#{id}, #{item.id}, #{grn.id}, #{packSize}, #{poNo}, #{ccmID.id}, #{limid}, #{postingDate}, #{expiryDate}, #{categoryId.id}, #{medicalCode}, #{vendorId.id},
         #{ratePerUnit}, #{qtyReceived}, #{qtyAllocated}, #{qtyDispatched}, #{numBoxes}, #{unitAllocation}, #{batchNo}, GETDATE(), #{createdBy}, GETDATE(), #{updatedBy}, #{hsnCode}, #{rate}, #{units})
    </insert>

</mapper>